## Customize the test machine
machine:
    php:
        version: 5.6.5
    services:
        - mysql
        - redis
database:
    post:
        - mysql -u root < $HOME/$CIRCLE_PROJECT_REPONAME/ddl/mysql/setup.sql
dependencies:
    pre:
        - composer config -g github-oauth.github.com $GITHUB_ACCESS_TOKEN
        - composer install --prefer-source --no-interaction
        - mkdir -p app/tmp/tests
        - chmod -R 777 app/tmp/tests
        - mkdir -p app2/tmp/tests
        - chmod -R 777 app2/tmp/tests
    post:
        - echo "<?php
          class DATABASE_CONFIG {
              public \$test = array(
              'datasource' => 'Database/Mysql',
              'persistent' => false,
              'host' => '127.0.0.1',
              'login' => 'ubuntu',
              'password' => '',
              'database' => 'sample_db',
              'prefix' => ''
              );
          }" > app/Config/database.php
        - echo "<?php
          class DATABASE_CONFIG {
              public \$test = array(
              'datasource' => 'Database/Mysql',
              'persistent' => false,
              'host' => '127.0.0.1',
              'login' => 'ubuntu',
              'password' => '',
              'database' => 'sample_db',
              'prefix' => ''
              );
          }" > app2/Config/database.php
test:
      override:
          - cd app; ./Console/cake Migrations.migration run all -p
          - ./Vendor/bin/phing build
          - find . -type f -regex ".*tests/junit.*.xml" -exec cat {} \;
      post:
          - find . -type f -regex ".*/app.*/tests/.*.xml" -exec cp {} $CIRCLE_ARTIFACTS/ \;
          - mkdir -p $CIRCLE_TEST_REPORTS/junit/
          - find . -type f -regex ".*tests/junit.*.xml" -exec cp {} $CIRCLE_TEST_REPORTS/junit/ \;
          - cp -R $CIRCLE_TEST_REPORTS/* $CIRCLE_ARTIFACTS/


