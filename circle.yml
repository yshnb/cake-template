## Customize the test machine
machine:
    php:
        version: 5.6.5
    services:
        - mysql
        - redis
database:
    post:
        - mysql -u root < $HOME/$CIRCLE_PROJECT_REPONAME/ddl/mysql/setup.sql
dependencies:
    pre:
        - composer config -g github-oauth.github.com $GITHUB_ACCESS_TOKEN
        - composer install --prefer-source --no-interaction
        - mkdir -p app/tmp/tests
        - chmod -R 777 app/tmp
        - mkdir -p app2/tmp/tests
        - chmod -R 777 app2/tmp
        - cd $HOME/$CIRCLE_PROJECT_REPONAME/
        - npm install -g phantomjs@1.9.7-14
        - npm install -g casperjs
        - cp $HOME/$CIRCLE_PROJECT_REPONAME/app.conf /etc/apache2/sites-available
        - a2ensite app.conf
        - sudo service apache2 restart
    post:
        - echo "<?php
          class DATABASE_CONFIG {
              public \$default = array(
              'datasource' => 'Database/Mysql',
              'persistent' => false,
              'host' => '127.0.0.1',
              'login' => 'ubuntu',
              'password' => '',
              'database' => 'sample_db',
              'prefix' => ''
              );

              public \$test = array(
              'datasource' => 'Database/Mysql',
              'persistent' => false,
              'host' => '127.0.0.1',
              'login' => 'ubuntu',
              'password' => '',
              'database' => 'test_sample_db',
              'prefix' => ''
              );
          }" > app/Config/database.php
        - echo "<?php
          class DATABASE_CONFIG {
              public \$default = array(
              'datasource' => 'Database/Mysql',
              'persistent' => false,
              'host' => '127.0.0.1',
              'login' => 'ubuntu',
              'password' => '',
              'database' => 'sample_db',
              'prefix' => ''
              );

              public \$test = array(
              'datasource' => 'Database/Mysql',
              'persistent' => false,
              'host' => '127.0.0.1',
              'login' => 'ubuntu',
              'password' => '',
              'database' => 'test_sample_db',
              'prefix' => ''
              );
          }" > app2/Config/database.php
test:
      override:
          - sudo chmod -R 777 app/tmp
          - sudo chmod -R 777 app2/tmp
          - ./Vendor/bin/phing build
          - find . -type f -regex ".*tests/junit.*.xml" -exec cat {} \;
          - ./app/Console/cake schema create -y
          - mysql -h 127.0.0.1 -u ubuntu sample_db < ./e2e/default.sql
          - sudo chmod -R 777 app/tmp
          - sudo chmod -R 777 app2/tmp
          - cd e2e/
          - casperjs test casper.js
      post:
          - find . -type f -regex ".*/app.*/tests/.*.xml" -exec cp {} $CIRCLE_ARTIFACTS/ \;
          - mkdir -p $CIRCLE_TEST_REPORTS/junit/
          - find . -type f -regex ".*tests/junit.*.xml" -exec cp {} $CIRCLE_TEST_REPORTS/junit/ \;
          - cp -R $CIRCLE_TEST_REPORTS/* $CIRCLE_ARTIFACTS/


